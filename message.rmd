---
title: "Analysis of mass shootings in the USA between 1966 and 2017"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE) 

Sys.setlocale("LC_TIME", "English")

require(ggplot2)
require(tidyverse)
require(lubridate)
require(scales)
require(usmap)
require(grid)
require(ggmap)
require(Rmisc)
require(MASS)
require(reshape2)

rm(list = ls())

shootings <- read_csv(file = "./US_Shootings_Cleaned.csv", na = c("unknown", "open;close"))

## Differents quantitative variables and their meaning:

## Fatalities: number of death caused by the shooting (including the shooter if applicable)
## Injured: number of person injured by the shooting (including the shooter if applicable)
## Total.victims: total number of injured or deaths caused by the shotings
## Policeman.Killed total number of policeman who died from the shooting
## Age/Age2: Age of the shooter/shooters at the moment of the incident

shootings.quantitative <- data.frame(
  Fatalities = shootings$Fatalities,
  Injured = shootings$Injured,
  Total.Victims = shootings$Total.victims,
  Policeman.Killed = shootings$Policeman.Killed,
  Age = shootings$Age,
  Age2 = shootings$Age2
)


shootings$Age <- as.numeric(shootings$Age)
shootings$Age2 <- as.numeric(shootings$Age2)
shootings$Policeman.Killed <- as.numeric(shootings$Policeman.Killed)
shootings$AverageAge <- as.numeric(shootings$AverageAge)


shootings.ages <- melt(data.frame(shootings.quantitative$Age, shootings.quantitative$Age2))
shootings.ages$variable <- NULL
colnames(shootings.ages) <- c("age")
shootings.ages$age <- as.numeric(shootings.ages$age)
```

## Introduction

Ce document est une présentation de plusieurs 

## Graphes

```{r fatalities}
ggplot(stack(shootings.quantitative[,-c(5,6)]), aes(x = ind, y = values, fill = ind)) +
  geom_boxplot() + scale_y_continuous(trans='pseudo_log')
```

On fait le graphique pour Age/Age2 séparéments car il y a plus de valeurs

```{r AgeBoxplot}
ggplot(stack(shootings.ages), aes(x = ind, y = values, fill = ind)) +
  geom_boxplot() + scale_y_continuous(trans='pseudo_log')

```

## Statistiques sur le nombre de mort

```{r fatalitieSummary}
summary(shootings.quantitative$Fatalities)
```


```{r fatalitiesCI}
CI(shootings.quantitative$Fatalities, ci=0.95)
```


```{r fatalitiesOutliers}
fatalities_outliers <- boxplot.stats(shootings.quantitative$Fatalities)$out
fatalities_outliers_row <- which(shootings.quantitative$Fatalities %in% c(fatalities_outliers))
 
shootings[fatalities_outliers_row,]
```

# Distribution

```{r fatalitiesDistibTest}
shapiro.test(shootings.quantitative$Fatalities)
```

On peux assumer que la loi n'est pas normale car p-value < 0.05 

```{r fatalitiesDistib}
ggplot(shootings.quantitative, aes(x=shootings.quantitative$Fatalities)) +
  geom_histogram(aes(y = ..density..), colour = "black", fill="darkorchid1") +
  geom_density()

```

On remarque que la distribution ressemble à une loi exponentielle, pour le tester on va utiliser un test "goodness of fit"

```{r fatalitiesExponential, echo=FALSE}

fit <- fitdistr(shootings.quantitative$Fatalities, "exponential")
ks.test(shootings.quantitative$Fatalities, "pexp", fit$estimate)

```

## Statistiques sur le nombre de blessés

```{r injured}
summary(shootings.quantitative$Injured)
```


```{r injuredCI}
CI(shootings.quantitative$Injured, ci=0.95)
```


```{r injuredOutliers}
injured_outliers <- boxplot.stats(shootings.quantitative$Injured)$out
injured_outliers_row <- which(shootings.quantitative$Injured %in% c(injured_outliers))
 
shootings[injured_outliers_row,]
```

# Distribution

```{r injuredDistibTest}
shapiro.test(shootings.quantitative$Injured)
```

On peux assumer que la loi n'est pas normale car p-value < 0.05 

```{r injuredDistib}
ggplot(shootings.quantitative, aes(x=Injured)) +
  geom_histogram(aes(y = ..density..), colour = "black", fill="darkorchid1", binwidth = 8) +
  geom_density()
```

On remarque que la distribution ressemble à une loi exponentielle, pour le tester on va utiliser un test "goodness of fit"

```{r injuredExponential, echo=FALSE}
fit <- fitdistr(shootings.quantitative$Injured, "exponential")
ks.test(shootings.quantitative$Injured, "pexp", fit$estimate)
```

## Statistiques sur le nombre total de victimes

```{r victims}
summary(shootings.quantitative$Total.Victims)
```


```{r victimsCI}
CI(shootings.quantitative$Total.Victims, ci=0.95)
```


```{r victimsOutliers}
victims_outliers <- boxplot.stats(shootings.quantitative$Total.Victims)$out
victims_outliers_row <- which(shootings.quantitative$Total.Victims %in% c(victims_outliers))
shootings[victims_outliers_row,]
```

```{r victimsDistibTest}
shapiro.test(shootings.quantitative$Total.Victims)
```

On peux assumer que la loi n'est pas normale car p-value <= 0.05 

```{r victimsDistib}
ggplot(shootings.quantitative, aes(x=Total.Victims)) +
  geom_histogram(aes(y = ..density..), colour = "black", fill="darkorchid1") +
  geom_density()
```

On remarque que la distribution ressemble à une loi exponentielle, pour le tester on va utiliser un test "goodness of fit"

```{r victimsExponential, echo=FALSE}
fit <- fitdistr(shootings.quantitative$Total.Victims, "exponential")
ks.test(shootings.quantitative$Total.Victims, "pexp", fit$estimate)
```

## Statistiques sur le nombre de policier tués

```{r policeman}
summary(as.numeric(shootings.quantitative$Policeman.Killed))
```


```{r policemanCI}
CI(as.numeric(shootings.quantitative$Policeman.Killed, ci=0.95))
```


```{r policemanOutliers}
policemans_outliers <- boxplot.stats(shootings.quantitative$Policeman.Killed)$out
policemans_outliers_row <- which(shootings.quantitative$Policeman.Killed %in% c(policemans_outliers))
shootings[policemans_outliers_row,]
```

```{r policemanDistibTest}
shapiro.test(shootings.quantitative$Policeman.Killed)
```

On peux assumer que la loi n'est pas normale car p-value <= 0.05 

```{r policemanDistib}
ggplot(shootings.quantitative, aes(x=Policeman.Killed)) +
  geom_histogram(aes(y = ..density..), colour = "black", fill="darkorchid1") +
  geom_density()
```

## Statistiques sur l'age

```{r age}
summary(shootings.ages$age)
```

```{r ageCI}
CI(shootings.ages$age, ci=0.95)
```

```{r ageOutliers}
ages_outliers <- boxplot.stats(shootings.ages$age)$out
ages_outliers_row <- which(shootings.ages %in% c(ages_outliers))
shootings[ages_outliers_row,]
```

Age n'a pas d'outliers

```{r ageDistibTest}
shapiro.test(shootings.ages$age)
```

On peux assumer que la loi n'est pas normale car p-value <= 0.05 

```{r ageDistib}
ggplot(shootings.ages, aes(x=age)) +
  geom_histogram(aes(y = ..density..), colour = "black", fill="darkorchid1") +
  geom_density()
```

# Associations with caterorical variables

```{r FatalitiesByMentalHeatlh}
ggplot(data=shootings, aes(x=Mental.Health.Issues, y=Fatalities, fill=Mental.Health.Issues)) +
  scale_fill_manual(values=c("orange1", "grey48", "firebrick1")) +
  geom_bar(stat="identity")
```

```{r VictimsByMentalHealth}
ggplot(data=shootings, aes(x=Mental.Health.Issues, y=Total.victims, fill=Mental.Health.Issues)) +
  scale_fill_manual(values=c("orange1", "grey48", "firebrick1")) +
  geom_bar(stat="identity")
```

```{r FatalitiesByYear}
ggplot(shootings, aes(x=Year, y=Fatalities)) +
  stat_summary(fun.y = sum, geom="line")
```

```{r VictimsByYear}
ggplot(shootings, aes(x=Year, y=Total.victims)) +
  stat_summary(fun.y = sum, geom="line")
```

```{r FatalitiesByIncidentArea, fig.width=16, fig.height=6}
ggplot(data=shootings, aes(x=reorder(Incident.Area, -Fatalities, function(x){ sum(x) }), y=Fatalities, fill=Incident.Area)) +
  theme(axis.text.x=element_text(angle=-30,hjust=0)) +
  xlab("Incident Area") +
  geom_bar(stat="identity")
```

```{r VictimsByIncidentArea, fig.width=16, fig.height=6}
ggplot(data=shootings, aes(x=reorder(Incident.Area, -Total.victims, function(x){ sum(x) }), y=Total.victims, fill=Incident.Area)) +
  theme(axis.text.x=element_text(angle=-30,hjust=0)) +
  xlab("Incident Area") +
  geom_bar(stat="identity")
```

Age Year

```{r AgeByYear}
ggplot(shootings, aes(x=Year, y=AverageAge)) +
  stat_summary(fun.y = mean, geom="line", na.rm = TRUE) +
  geom_smooth(na.rm = TRUE)
```

```{r rowByYears}
ggplot(shootings, aes(x=Year, fill=..count..)) +
  geom_histogram(aes(y = stat(count)), colour="grey48", binwidth = 1) +
  scale_fill_gradient(low='white', high='orangered', trans = "pseudo_log")
```


```{r rowByDayOfWeek}
day_order <- c('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday')
ggplot(data=shootings, aes(x=factor(Day, level = day_order), fill=Day)) +
  xlab("Day of week") +
  geom_bar()
```

```{r rowByMonth}
month_order <- c('January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December')
ggplot(data=shootings, aes(x=factor(Month, level = month_order), fill=Month)) +
  theme(axis.text.x=element_text(angle=-30,hjust=0)) +
  xlab("Month") +
  geom_bar()
```

# Test des correlations

```{r anovaFatalitiesRace}
summary(aov(Fatalities ~ Race, data = shootings))
```

```{r anovaVictimsRace}
summary(aov(Total.victims ~ Race, data = shootings))
```



```{r anovaFatalitiesByWeaponTypes}
summary(aov(Fatalities ~ Weapon.Type, data = shootings))
```

```{r anovaVictimsByWeaponTypes}
summary(aov(Total.victims ~ Weapon.Type, data = shootings))
```


```{r anovaFatalitiesByCause}
summary(aov(Fatalities ~ Cause, data = filter(shootings, Cause != "unknown")))
```

```{r anovaVictimsByCause}
summary(aov(Total.victims ~ Cause, data = filter(shootings, Cause != "unknown")))
```


```{r anovaAgeByCause}
summary(aov(AverageAge ~ Cause, data = filter(shootings, Cause != "unknown")))
```

3.3

Total Victims

```{r setupTTest, echo=FALSE}
```

```{r tTestsTotalVictimsMental}
t.test(shootings$Total.victims ~ shootings$Mental.Health.Issues)
```

```{r tTestsTotalVictimsOpenClose}
t.test(shootings$Total.victims ~ shootings$Open.Close.Location)
```

```{r tTestsTotalVictimsGender}
t.test(shootings$Total.victims ~ shootings$Gender)
```

Age

```{r tTestsAgeMental}
t.test(shootings$AverageAge ~ shootings$Mental.Health.Issues)
```

```{r tTestsAgeOpenClose}
t.test(shootings$AverageAge ~ shootings$Open.Close.Location)
```

```{r tTestsAgeGender}
t.test(shootings$Age ~ shootings$Gender)
```

3.5

```{r VictimsByYear2, echo=FALSE}
shootings.by.year.victims <- shootings %>%
  dplyr::group_by(Year) %>%
  dplyr::summarise(Total.victims = sum(Total.victims))

shootings.by.year.fatalities <- shootings %>%
  dplyr::group_by(Year) %>%
  dplyr::summarise(Fatalities = sum(Fatalities))

shootings.by.year.injured <- shootings %>%
  dplyr::group_by(Year) %>%
  dplyr::summarise(Injured = sum(Injured))

shootings.by.year <- merge(shootings.by.year.fatalities, shootings.by.year.victims, by = c("Year"))
shootings.by.year <- merge(shootings.by.year, shootings.by.year.injured, by = c("Year"))
```

```{r shootingsByYearVictims}
ggplot(shootings.by.year, aes(x=Year, y=Total.victims)) +
  geom_point(size=2, aes(size=20)) + 
  stat_summary(fun.y = sum, geom="line")
```

```{r shootingsByYearAll, fig.width=16, fig.height=6}
ggplot(shootings.by.year, aes(x=Year)) +
  geom_line(aes(Year, Fatalities, color="Fatalities"), size=1) +
  geom_line(aes(Year, Injured, color="Injured"), size=1) +
  geom_line(aes(Year, Total.victims, color="Total Victims"), size=1) +
  scale_colour_manual(values = c("Fatalities" = "firebrick1", "Injured" = "orange", "Total Victims" = "gray40")) +
  ylab("Total")
```


```{r stack}
shootings$Total.victims <- as.numeric(shootings$Total.victims)
shootings$Injured <- as.numeric(shootings$Injured)
shootings$Fatalities <- as.numeric(shootings$Fatalities)

data <- shootings %>% 
  gather(key = "variable", value = "value", Injured, Fatalities)
data <- data[,c("variable", "value", "Year")]

data <- data  %>%
  dplyr::group_by(Year, variable) %>%
  dplyr::summarise(n = sum(value)) %>%
  dplyr::mutate(percentage = n / sum(n))

View(data)
ggplot(data, aes(x=Year, y = percentage, fill = variable)) +
  geom_area(color = "black")
```

```{r victimsPredictions}
victims.regression.linear <- lm(Total.victims ~ Year, data=shootings.by.year)

summary(victims.regression.linear)
```

Une régression linéaire n'est pas satisfaisante

```{r victimsPredictions}
victims.regression.exp <- lm(log(Total.victims) ~ Year, data=shootings.by.year)

summary(victims.regression.exp)
```

```{r regressionPlot}
shootings.by.year %>%
  mutate( model = predict(victims.regression.linear)) %>%
  mutate( model.exp = exp(predict(victims.regression.exp))) %>%
  ggplot(x = Year) +
  geom_point( aes(Year, Total.victims)) +
  geom_line( aes(Year, model, colour="linear")) +
  geom_line( aes(Year, model.exp, colour="exp")) +
  scale_colour_manual(name = 'Regressions', values =c('linear'='orange','exp'='firebrick1'))
```



```{r 2010victimsPredictions}
shootings.by.year.2010 <- filter(shootings.by.year, Year >= 2010)

victims.regression.linear.2010 <- lm(Total.victims ~ Year, data=shootings.by.year.2010)

summary(victims.regression.linear.2010)
```

Une régression linéaire n'est pas satisfaisante

```{r 2010victimsPredictions}
victims.regression.exp.2010 <- lm(log(Total.victims) ~ Year, data=shootings.by.year.2010)

summary(victims.regression.exp.2010)
```

```{r 2010regressionPlot}
shootings.by.year.2010 %>%
  mutate( model = predict(victims.regression.linear.2010)) %>%
  mutate( model.exp = exp(predict(victims.regression.exp.2010))) %>%
  ggplot(x = Year) +
  geom_point( aes(Year, Total.victims) ) +
  geom_line( aes(Year, model, colour="linear")) +
  geom_line( aes(Year, model.exp, colour="exp")) +
  scale_colour_manual(name = 'Regressions', values =c('linear'='orange','exp'='firebrick1'))
```

```{r predictFuture}
dates <- data.frame(Year=c(2018, 2020, 2025, 2030, 2050, 2075, 2100))
predict(victims.regression.linear, dates)
```

```{r predictFutureExp}
dates <- data.frame(Year=c(2018, 2020, 2025, 2030, 2050, 2075, 2100))
exp(predict(victims.regression.exp, dates))
```

```{r predictFuture2010}
dates <- data.frame(Year=c(2018, 2020, 2025, 2030, 2050, 2075, 2100))
predict(victims.regression.linear.2010, dates)
```

```{r predictFutureExp2010}
dates <- data.frame(Year=c(2018, 2020, 2025, 2030, 2050, 2075, 2100))
exp(predict(victims.regression.exp.2010, dates))
```

4

```{r MapScatterplot1}
qmplot(Longitude, Latitude, data = shootings, maptype = "toner-lite", color = "red", size = I(1)) +
  labs(title = "Shootings' Location\n", x = "", y = "", color = "Legend") +
  scale_color_manual(labels = c("Shootings"), values = c("red"))
```

5

```{r MapKmeansCluster}
shootings.TotalVictims <- shootings[rep(seq_len(dim(shootings)[1]), shootings$Total.victims), 1:25]

clusters <- kmeans(shootings.TotalVictims[c('Latitude', 'Longitude')], 6)

# Save the cluster number in the dataset as column
shootings.TotalVictims$Clusters <- as.factor(clusters$cluster)

qmplot(Longitude, Latitude, data = shootings.TotalVictims, maptype = "terrain-background", color = Clusters) +
  labs(title = "K Means clustering Visualition of mass shootings in the US\n", x = "", y = "", color = "Clusters") +
  scale_color_manual(labels = c("North Central US", "Rockies", "South East Coast", "North East Coast", "South Central US", "West Coast"),
                     values =  c("red", "chocolate", "green", "blue", "yellow", "deeppink"))

```

6
```{r MapHierarchicalCluster}
hierachical.cluster <- hclust(dist(shootings.TotalVictims[c('Latitude', 'Longitude')]))
plot(hierachical.cluster)
cut_cluster <- cutree(hierachical.cluster, k = 7)

shootings.TotalVictims$HierarchicalClusters <- as.factor(cut_cluster)

qmplot(Longitude, Latitude, data = shootings.TotalVictims, maptype = "terrain-background", color = HierarchicalClusters) +
  labs(title = "Hierarchical clustering Visualition of mass shootings in the US\n", x = "", y = "", color = "Clusters") +
  scale_color_manual(labels = c("South / South East US", "Rockies", "North East Coast", "West Coast", "US Central", "Hawaii", "Alaska"),
                     values =  c("red", "chocolate", "green", "blue", "yellow", "deeppink", "turquoise2"))
```